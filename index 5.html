<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leads Metrics Dashboard — Dummy Data (Plotly + SVG Fallback)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --ink:#0f172a; --muted:#475569; --ring:#2563eb33;
      --border:#e2e8f0; --shadow: 0 6px 22px rgba(2,6,23,.06); --accent:#2563eb; --ok:#16a34a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1150px;margin:0 auto;padding:14px}
    header{position:sticky;top:0;z-index:5;background:rgba(255,255,255,.92);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .head-row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:12px 14px}
    .title h1{margin:0;font-size:20px;font-weight:700} .title small{color:var(--muted)}
    details.filters{margin:10px 14px;border:1px solid var(--border);border-radius:12px;background:#fafbff;box-shadow:var(--shadow)}
    details.filters>summary{list-style:none;cursor:pointer;padding:12px 14px;color:var(--muted)}
    details.filters[open]>summary{border-bottom:1px solid var(--border)}
    .filters-grid{display:grid;gap:10px;grid-template-columns:repeat(9,minmax(140px,1fr));padding:12px}
    @media (max-width:1200px){.filters-grid{grid-template-columns:repeat(3,minmax(160px,1fr))}}
    @media (max-width:700px){.filters-grid{grid-template-columns:repeat(2,minmax(150px,1fr))}}
    label{display:grid;gap:6px;font-size:12px;color:var(--muted)}
    select{appearance:none;background:#ffffff;color:#0f172a;border:1px solid var(--border);border-radius:10px;padding:8px 10px;outline:none}
    select:focus{box-shadow:inset 0 0 0 1px var(--ring);border-color:var(--ring)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:#f8fafc;color:#0f172a;border:1px solid var(--border);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{background:#f1f5f9}
    .grid{display:grid;gap:14px;grid-template-columns:1fr}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin:0 14px;box-shadow:var(--shadow)}
    .panel h3{margin:0 0 6px;font-size:15px;font-weight:600}
    .panel .sub{color:var(--muted);font-size:12px;margin-bottom:6px}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:8px 0}
    .kpi{background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
    .kpi h4{margin:0 0 4px;font-size:12px;color:var(--muted)}
    .kpi .big{font-size:22px;font-weight:800}
    .kpi .small{font-size:12px;color:var(--muted)}
    .progress{width:100%;height:10px;background:#eef2f7;border-radius:6px;overflow:hidden;margin-top:6px;border:1px solid var(--border)}
    .progress > div{height:100%; background:linear-gradient(90deg, var(--accent), #38bdf8);}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
    .controls label{font-size:12px;color:var(--muted)}
    .chart{height:360px; position:relative}
    .svg-chart{width:100%; height:100%; border:1px solid var(--border); border-radius:10px; background:#fff}
    footer{color:var(--muted);font-size:12px;margin:12px 0 30px;text-align:center}
    .diag{position:fixed;bottom:10px;left:10px;background:#0f172a;color:white;padding:8px 10px;border-radius:8px;font-size:12px;opacity:.9;z-index:50}
    .diag b{color:#a7f3d0}
    .muted{color:var(--muted);font-size:12px;margin-left:8px}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <div id="diag" class="diag">Loading…</div>
  <header>
    <div class="head-row wrap">
      <div class="title">
        <h1>Leads Metrics — Dummy Data</h1>
        <small id="asOf"></small>
      </div>
      <div class="toolbar">
        <button class="btn" id="toggleFilters">Show filters</button>
        <button class="btn" id="resetBtn">Reset</button>
      </div>
    </div>
    <details class="filters" id="filtersBlock">
      <summary>Filters</summary>
      <div class="filters-grid wrap" style="padding-top:0;">
        <label>By country
          <select id="f_country">
            <option>Indonesia</option>
            <option>Malaysia</option>
            <option>Phillipine</option>
            <option>Thailand</option>
            <option>Vietnam</option>
          </select>
        </label>
        <label>By partner category
          <select id="f_partnerCat">
            <option>VC Partner</option>
            <option>Referral partner</option>
            <option>AM managed Partners</option>
            <option>Alliance Partner</option>
            <option>Distribution Partner</option>
            <option>TPI Partner</option>
            <option>Embedded partner</option>
            <option>Refferal Others</option>
            <option>All</option>
          </select>
        </label>
        <label>By agreement type
          <select id="f_agreement">
            <option>Revenue Sharing</option>
            <option>Non Revenue Sharing</option>
            <option>All</option>
          </select>
        </label>
        <label>By Industry
          <select id="f_industry">
            <option>Digital Product</option>
            <option>Entertainment</option>
            <option>Property</option>
            <option>Financial Service</option>
            <option>Travel&Hospitality</option>
            <option>Non Profit</option>
            <option>Retail</option>
            <option>Services</option>
            <option>Other</option>
            <option>All</option>
          </select>
        </label>
        <label>By CPM
          <select id="f_cpm">
            <option>Charisse</option>
            <option>OT</option>
            <option>Hanna</option>
            <option>Rizki</option>
            <option>All</option>
          </select>
        </label>
        <label>By product
          <select id="f_product">
            <option>VA</option>
            <option>eWallet</option>
            <option>Cards</option>
            <option>Direct Debit</option>
            <option>QR Code</option>
            <option>All</option>
          </select>
        </label>
        <label>By Lead Sales flow
          <select id="f_lead">
            <option>Self Serve</option>
            <option>Sales</option>
            <option>CPM</option>
            <option>All</option>
          </select>
        </label>
        <label>By Marketing activity
          <select id="f_mkt">
            <option>Event campaign</option>
            <option>Campaign</option>
            <option>Non Marketing</option>
          </select>
        </label>
        <label>By merchant age
          <select id="f_age">
            <option>Less than 6 months transacting</option>
            <option>More than 6 months transacting</option>
            <option>All</option>
          </select>
        </label>
      </div>
    </details>
  </header>

  <main class="wrap">
    <section class="panel">
      <h3>Lead's Target</h3>
      <div class="sub">MTD target and % achieved vs quarterly target (mock data).</div>
      <div class="kpis">
        <div class="kpi">
          <h4>MTD Target</h4>
          <div class="big" id="kpi_mtd_target">—</div>
          <div class="small">Monthly target × day progress</div>
        </div>
        <div class="kpi">
          <h4>Quarterly Target</h4>
          <div class="big" id="kpi_q_target">—</div>
          <div class="small">Prior quarter +10%</div>
        </div>
        <div class="kpi">
          <h4>Quarter Achieved</h4>
          <div class="big"><span id="kpi_q_achieve_pct">—</span></div>
          <div class="progress"><div id="progressFill" style="width:0%"></div></div>
          <div class="small"><span id="kpi_q_achieve_num">—</span> / <span id="kpi_q_achieve_den">—</span> leads</div>
        </div>
      </div>
    </section>

    <section class="panel">
      <h3>Lead's Financial Metrics</h3>
      <div class="controls">
        <label>Group by</label>
        <select id="groupBy">
          <option>Sales Flow</option>
          <option>Partner Type</option>
        </select>
        <span class="muted" id="renderMode">(rendering…)</span>
      </div>
      <div class="sub">Average Gross / Net / Net Net revenue per month for last 12 months.</div>
      <div id="ch_avg_gross" class="chart"></div>
      <div id="ch_avg_net" class="chart"></div>
      <div id="ch_avg_netnet" class="chart"></div>
      <div class="hint" id="fallbackHint" style="display:none">Showing simplified SVG charts because Plotly could not load in your environment.</div>
    </section>

    <footer>This page includes an offline SVG fallback so charts ALWAYS render with the dummy data.</footer>
  </main>

  <script>
  (function(){
    const diag = document.getElementById('diag');
    function log(msg){ diag.innerHTML = msg; }

    // Try to load Plotly from CDN with fallbacks
    const sources = [
      'https://cdn.plot.ly/plotly-2.35.2.min.js',
      'https://cdn.jsdelivr.net/npm/plotly.js-dist@2.35.2/plotly.min.js',
      'https://unpkg.com/plotly.js-dist@2.35.2/plotly.min.js'
    ];
    let __plotlyLoaded = false, __usedSVG = false;

    function loadScriptWithFallback(i){
      if(i >= sources.length){
        log("<b>ℹ️ Plotly not available.</b> Using offline SVG charts.");
        __usedSVG = true;
        startApp(); // will render SVG charts
        return;
      }
      const url = sources[i];
      log("Loading Plotly…<br><small>("+url+")</small>");
      const s = document.createElement('script');
      s.src = url; s.async = true;
      s.onload = ()=>{ __plotlyLoaded = true; log("<b>✅ Plotly loaded.</b>"); startApp(); };
      s.onerror = ()=>{ log("Failed: "+url+"<br>Trying next…"); setTimeout(()=>loadScriptWithFallback(i+1), 150); };
      document.head.appendChild(s);
    }
    loadScriptWithFallback(0);

    function startApp(){
      const now = new Date();
      function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
      function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
      function addMonths(d,n){ const x=new Date(d); x.setMonth(x.getMonth()+n); return x; }
      function monthShort(y,m){ return new Date(y,m,1).toLocaleString('en-US',{month:'short'}); }
      function fmt(n){ return new Intl.NumberFormat('en-SG',{notation:'compact',maximumFractionDigits:1}).format(n); }

      // Seeded RNG
      function mulberry32(a){ return function(){ let t=a += 0x6D2B79F5; t = Math.imul(t ^ t>>>15, t | 1); t ^= t + Math.imul(t ^ t>>>7, t | 61); return ((t ^ t>>>14) >>> 0) / 4294967296; } }
      let rng = mulberry32(777777);
      function rand(a=0,b=1){ return a + (b-a)*rng(); }
      function choice(arr){ return arr[Math.floor(rand(0,arr.length))]; }

      // Dimensions / enums
      const Countries = ["Indonesia","Malaysia","Phillipine","Thailand","Vietnam"];
      const PartnerCats = ["VC Partner","Referral partner","AM managed Partners","Alliance Partner","Distribution Partner","TPI Partner","Embedded partner","Refferal Others"];
      const Agreements = ["Revenue Sharing","Non Revenue Sharing"];
      const Industries = ["Digital Product","Entertainment","Property","Financial Service","Travel&Hospitality","Non Profit","Retail","Services","Other"];
      const CPMs = ["Charisse","OT","Hanna","Rizki"];
      const Products = ["VA","eWallet","Cards","Direct Debit","QR Code"];
      const LeadFlows = ["Self Serve","Sales","CPM"];
      const MktActs = ["Event campaign","Campaign","Non Marketing"];

      // Mock partners
      const Partners = Array.from({length: 160}).map((_,i)=>{
        const product = choice(Products);
        const industry = choice(Industries);
        const country = choice(Countries);
        const baseTPV = (
          product==='Cards' ? rand(400000, 5000000) :
          product==='eWallet' ? rand(250000, 3000000) :
          product==='QR Code' ? rand(180000, 1500000) :
          product==='Direct Debit'? rand(120000, 900000) :
          rand(150000, 1200000)
        );
        const grossRate = rand(0.006, 0.02);
        const netRate   = Math.max(0.002, grossRate - rand(0.001, 0.006));
        const netNetRate= Math.max(0.001, netRate   - rand(0.0005, 0.004));
        const monthsAgo = Math.floor(rand(0, 16));
        const activation = new Date(now.getFullYear(), now.getMonth()-monthsAgo, 1 + Math.floor(rand(0,25)));
        return { id:'P'+(i+1), country, partnerCat:choice(PartnerCats), agreement:choice(Agreements), industry, cpm:choice(CPMs), product, lead:choice(LeadFlows), mkt:choice(MktActs), activation, baseTPV, grossRate, netRate, netNetRate };
      });

      function seasonalFactor(month, industry){
        let f = 1.0;
        if(industry==='Retail'){ if(month===10||month===11) f += 0.18; if(month===0) f -= 0.05; }
        if(industry==='Travel&Hospitality'){ if(month===5||month===6) f += 0.15; if(month===1) f -= 0.05; }
        if(industry==='Entertainment'){ if(month===11) f += 0.10; }
        return f;
      }
      function getFilters(){
        return {
          country: document.getElementById('f_country').value,
          partnerCat: document.getElementById('f_partnerCat').value,
          agreement: document.getElementById('f_agreement').value,
          industry: document.getElementById('f_industry').value,
          cpm: document.getElementById('f_cpm').value,
          product: document.getElementById('f_product').value,
          lead: document.getElementById('f_lead').value,
          mkt: document.getElementById('f_mkt').value,
          age: document.getElementById('f_age').value,
        };
      }
      function partnerMatches(p, f){
        if(p.country!==f.country) return false;
        if(f.partnerCat!=='All' && p.partnerCat!==f.partnerCat) return false;
        if(f.agreement!=='All' && p.agreement!==f.agreement) return false;
        if(f.industry!=='All' && p.industry!==f.industry) return false;
        if(f.cpm!=='All' && p.cpm!==f.cpm) return false;
        if(f.product!=='All' && p.product!==f.product) return false;
        if(f.lead!=='All' && p.lead!==f.lead) return false;
        if(p.mkt!==f.mkt) return false;
        const monthsActive = (now.getFullYear()-p.activation.getFullYear())*12 + (now.getMonth()-p.activation.getMonth()) - (now.getDate()<p.activation.getDate()?1:0);
        if(f.age==='Less than 6 months transacting' && monthsActive>=6) return false;
        if(f.age==='More than 6 months transacting' && monthsActive<6) return false;
        return true;
      }
      function aggregateMonthly(N=12, filters=getFilters()){
        const months = [];
        const monthly = Array.from({length:N}, ()=>({ tpv:0, gross:0, net:0, netnet:0, leads:0 }));
        for(let k=N-1;k>=0;k--){
          const d = startOfMonth(addMonths(now, -k));
          months.push({ y:d.getFullYear(), m:d.getMonth(), dim:daysInMonth(d.getFullYear(), d.getMonth()) });
        }
        const selected = Partners.filter(p=>partnerMatches(p, filters));
        monthly.forEach(mo=>{
          mo.byFlow = { "Self Serve":{gross:0,net:0,netnet:0,count:0}, "Sales":{gross:0,net:0,netnet:0,count:0}, "CPM":{gross:0,net:0,netnet:0,count:0} };
          mo.byPartner = { "VC Partner":{gross:0,net:0,netnet:0,count:0}, "Referral partner":{gross:0,net:0,netnet:0,count:0}, "AM managed Partners":{gross:0,net:0,netnet:0,count:0}, "Alliance Partner":{gross:0,net:0,netnet:0,count:0}, "Distribution Partner":{gross:0,net:0,netnet:0,count:0}, "TPI Partner":{gross:0,net:0,netnet:0,count:0}, "Embedded partner":{gross:0,net:0,netnet:0,count:0} };
        });
        selected.forEach(p=>{
          months.forEach((mo, idx)=>{
            const monthStart = new Date(mo.y, mo.m, 1);
            if(p.activation > new Date(mo.y, mo.m, mo.dim)) return;
            const monthsActive = (monthStart.getFullYear()-p.activation.getFullYear())*12 + (monthStart.getMonth()-p.activation.getMonth());
            const growth = Math.min(1 + 0.015*monthsActive, 2.2);
            const season = seasonalFactor(mo.m, p.industry);
            const noise = 0.9 + 0.2*rand();
            const tpv = p.baseTPV * growth * season * noise;
            const gross = tpv * p.grossRate;
            const net   = tpv * p.netRate;
            const netnet= tpv * p.netNetRate;
            monthly[idx].tpv   += tpv;
            monthly[idx].gross += gross;
            monthly[idx].net   += net;
            monthly[idx].netnet+= netnet;
            monthly[idx].leads += Math.max(0, Math.round((tpv/20000) * (0.7 + 0.6*rand())));
            monthly[idx].byFlow[p.lead].gross += gross;
            monthly[idx].byFlow[p.lead].net   += net;
            monthly[idx].byFlow[p.lead].netnet+= netnet;
            monthly[idx].byFlow[p.lead].count += 1;
            if(monthly[idx].byPartner[p.partnerCat]){
              monthly[idx].byPartner[p.partnerCat].gross += gross;
              monthly[idx].byPartner[p.partnerCat].net   += net;
              monthly[idx].byPartner[p.partnerCat].netnet+= netnet;
              monthly[idx].byPartner[p.partnerCat].count += 1;
            }
          });
        });
        // Leads targets (cards)
        const monthsInQuarter = (m)=>{ const q = Math.floor(m/3); return [q*3, q*3+1, q*3+2]; };
        const curMonth = months[months.length-1];
        const prevQuarterMonths = monthsInQuarter((curMonth.m+9)%12);
        let prevQuarterLeads = 0;
        months.forEach((mo, idx)=>{ if(prevQuarterMonths.includes((mo.m))) prevQuarterLeads += monthly[idx].leads; });
        const quarterTarget = Math.round(prevQuarterLeads * 1.10);
        return { months, monthly, quarterTarget };
      }

      function monthLabels(months){ return months.map(m=> monthShort(m.y, m.m)); }

      function computeAvgSeries({months, monthly}, kind, mode){
        const labels = monthLabels(months);
        const groups = (mode==='Sales Flow')
          ? ["Self Serve","Sales","CPM"]
          : ["VC Partner","Referral partner","AM managed Partners","Alliance Partner","Distribution Partner","TPI Partner","Embedded partner"];
        const series = groups.map(g=>({ name:g, y:[] }));
        for(let i=0;i<monthly.length;i++){
          if(mode==='Sales Flow'){
            groups.forEach((g,gi)=>{
              const b = monthly[i].byFlow[g];
              const v = b.count>0 ? b[kind]/b.count : 0;
              series[gi].y.push(v);
            });
          } else {
            groups.forEach((g,gi)=>{
              const b = monthly[i].byPartner[g] || {gross:0,net:0,netnet:0,count:0};
              const v = b.count>0 ? b[kind]/b.count : 0;
              series[gi].y.push(v);
            });
          }
        }
        return { labels, series };
      }

      function updateCards({months, monthly, quarterTarget}){
        const cur = monthly[monthly.length-1];
        const curMonth = months[months.length-1];
        const dayN = new Date().getDate();
        const dim = curMonth.dim;
        const prevLeads = monthly[monthly.length-2]?.leads || 0;
        const monthlyTarget = Math.round(prevLeads * 1.05);
        const mtdTarget = Math.round(monthlyTarget * dayN / dim);
        const q = Math.floor(curMonth.m/3);
        const qMonths = [q*3, q*3+1, q*3+2];
        let quarterAchieved = 0;
        months.forEach((mo, idx)=>{
          if(!qMonths.includes(mo.m)) return;
          if(idx === months.length-1) quarterAchieved += Math.round((cur.leads) * dayN / dim);
          else quarterAchieved += monthly[idx].leads;
        });
        const pct = quarterTarget>0 ? Math.min(100, Math.round(quarterAchieved*100/quarterTarget)) : 0;
        document.getElementById('kpi_mtd_target').textContent = mtdTarget.toLocaleString('en-US') + " leads";
        document.getElementById('kpi_q_target').textContent = quarterTarget.toLocaleString('en-US') + " leads";
        document.getElementById('kpi_q_achieve_pct').textContent = pct + "%";
        document.getElementById('kpi_q_achieve_num').textContent = quarterAchieved.toLocaleString('en-US');
        document.getElementById('kpi_q_achieve_den').textContent = quarterTarget.toLocaleString('en-US');
        const tzDate = new Date();
        document.getElementById('asOf').textContent = `As of ${tzDate.toLocaleDateString('en-SG',{year:'numeric',month:'long',day:'numeric'})}`;
        document.getElementById('progressFill').style.width = pct + "%";
      }

      // ---------- SVG fallback renderer ----------
      function renderGroupedBarsSVG(el, labels, series){
        const W = el.clientWidth || 1000, H = el.clientHeight || 360;
        el.innerHTML = ''; // clear
        const svgNS = 'http://www.w3.org/2000/svg';
        const svg = document.createElementNS(svgNS, 'svg');
        svg.setAttribute('width', W);
        svg.setAttribute('height', H);
        svg.classList.add('svg-chart');
        el.appendChild(svg);

        const padding = {l:60,r:20,t:10,b:36};
        const innerW = W - padding.l - padding.r;
        const innerH = H - padding.t - padding.b;

        // Axes groups
        const g = document.createElementNS(svgNS, 'g');
        g.setAttribute('transform', `translate(${padding.l},${padding.t})`);
        svg.appendChild(g);

        // Compute max
        let maxY = 0;
        series.forEach(s=> s.y.forEach(v=> { if(v>maxY) maxY = v; }));
        if(maxY<=0) maxY = 1;
        // grid lines
        const gridCount = 5;
        for(let i=0;i<=gridCount;i++){
          const y = innerH - (innerH * i / gridCount);
          const line = document.createElementNS(svgNS, 'line');
          line.setAttribute('x1',0); line.setAttribute('y1',y);
          line.setAttribute('x2',innerW); line.setAttribute('y2',y);
          line.setAttribute('stroke','#eef2f7'); line.setAttribute('stroke-width','1');
          g.appendChild(line);
          // y labels
          const lbl = document.createElementNS(svgNS, 'text');
          lbl.setAttribute('x', -8);
          lbl.setAttribute('y', y+4);
          lbl.setAttribute('text-anchor','end');
          lbl.setAttribute('fill','#334155');
          lbl.setAttribute('font-size','11');
          lbl.textContent = formatMoney(maxY * i / gridCount);
          g.appendChild(lbl);
        }

        const groupCount = series.length;
        const n = labels.length;
        const bandWidth = innerW / n;
        const gap = 0.1 * bandWidth;
        const barWidth = (bandWidth - gap) / groupCount;

        // colors
        const colors = ['#2563eb','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#84cc16'];

        // Bars
        labels.forEach((lbl, i)=>{
          series.forEach((s, gi)=>{
            const x = i*bandWidth + gap/2 + gi*barWidth;
            const yVal = s.y[i] || 0;
            const h = (yVal / maxY) * innerH;
            const rect = document.createElementNS(svgNS, 'rect');
            rect.setAttribute('x', x);
            rect.setAttribute('y', innerH - h);
            rect.setAttribute('width', barWidth * 0.9);
            rect.setAttribute('height', h);
            rect.setAttribute('fill', colors[gi % colors.length]);
            rect.setAttribute('opacity','0.9');
            g.appendChild(rect);
          });
          // x labels
          const tx = document.createElementNS(svgNS, 'text');
          tx.setAttribute('x', i*bandWidth + bandWidth/2);
          tx.setAttribute('y', innerH + 18);
          tx.setAttribute('text-anchor','middle');
          tx.setAttribute('fill','#334155');
          tx.setAttribute('font-size','11');
          tx.textContent = lbl;
          g.appendChild(tx);
        });

        // y axis title
        const yTitle = document.createElementNS(svgNS, 'text');
        yTitle.setAttribute('x', -padding.l + 10);
        yTitle.setAttribute('y', -4);
        yTitle.setAttribute('fill','#334155');
        yTitle.setAttribute('font-size','12');
        yTitle.textContent = 'Avg Revenue (S$)';
        g.appendChild(yTitle);

        // legend
        const lg = document.createElementNS(svgNS, 'g');
        let lx = 0, ly = -2;
        series.forEach((s, gi)=>{
          const sw = 16, sh = 10, sp = 8, txoff = 22;
          const rect = document.createElementNS(svgNS, 'rect');
          rect.setAttribute('x', lx);
          rect.setAttribute('y', ly);
          rect.setAttribute('width', sw);
          rect.setAttribute('height', sh);
          rect.setAttribute('fill', colors[gi % colors.length]);
          lg.appendChild(rect);
          const tt = document.createElementNS(svgNS, 'text');
          tt.setAttribute('x', lx + txoff);
          tt.setAttribute('y', ly + sh - 1);
          tt.setAttribute('fill','#334155');
          tt.setAttribute('font-size','11');
          tt.textContent = s.name;
          lg.appendChild(tt);
          lx += txoff + s.name.length*6 + sp;
        });
        lg.setAttribute('transform', `translate(0, ${-padding.t+12})`);
        g.appendChild(lg);
      }

      function formatMoney(n){
        if(!isFinite(n)) return '0';
        if(n>=1e9) return 'S$ ' + (n/1e9).toFixed(1)+'B';
        if(n>=1e6) return 'S$ ' + (n/1e6).toFixed(1)+'M';
        if(n>=1e3) return 'S$ ' + (n/1e3).toFixed(1)+'k';
        return 'S$ ' + Math.round(n);
      }

      function drawAll(){
        const data = aggregateMonthly(12, getFilters());
        updateCards(data);
        const mode = document.getElementById('groupBy').value;
        document.getElementById('renderMode').textContent = __plotlyLoaded ? '(Plotly)' : '(SVG fallback)';
        document.getElementById('fallbackHint').style.display = __plotlyLoaded ? 'none':'block';

        const plots = [
          { kind:'gross', el:'ch_avg_gross', title:'Avg Gross Revenue (S$)' },
          { kind:'net', el:'ch_avg_net', title:'Avg Net Revenue (S$)' },
          { kind:'netnet', el:'ch_avg_netnet', title:'Avg Net Net Revenue (S$)' }
        ];

        if(__plotlyLoaded && window.Plotly){
          const baseLayout = {
            paper_bgcolor:'white', plot_bgcolor:'white',
            barmode:'group',
            margin:{l:60,r:20,t:10,b:44},
            xaxis:{ title:'Month', gridcolor:'#eef2f7', zerolinecolor:'#cbd5e1', tickfont:{color:'#334155'}, titlefont:{color:'#334155'} },
            yaxis:{ title:'Avg Revenue (S$)', gridcolor:'#eef2f7', zerolinecolor:'#cbd5e1', tickprefix:'S$ ', separatethousands:true, tickfont:{color:'#334155'}, titlefont:{color:'#334155'} },
            legend:{ orientation:'h', y:1.12, x:0, font:{color:'#0f172a'} }
          };
          plots.forEach(p=>{
            const {labels, series} = computeAvgSeries(data, p.kind, mode);
            const traces = series.map(s=>({type:'bar', name:s.name, x:labels, y:s.y}));
            const layout = Object.assign({}, baseLayout, { yaxis:Object.assign({}, baseLayout.yaxis, {title:p.title}) });
            Plotly.react(document.getElementById(p.el), traces, layout, {displayModeBar:true, responsive:true});
          });
        } else {
          plots.forEach(p=>{
            const {labels, series} = computeAvgSeries(data, p.kind, mode);
            renderGroupedBarsSVG(document.getElementById(p.el), labels, series);
          });
        }
        diag.style.display = 'none';
      }

      // UI hooks
      const fb = document.getElementById('filtersBlock'); fb.open = false;
      document.getElementById('toggleFilters').addEventListener('click', ()=>{
        fb.open = !fb.open;
        document.getElementById('toggleFilters').textContent = fb.open ? 'Hide filters' : 'Show filters';
      });
      document.getElementById('resetBtn').addEventListener('click', ()=>{
        ['f_country','f_partnerCat','f_agreement','f_industry','f_cpm','f_product','f_lead','f_mkt','f_age'].forEach(id=> document.getElementById(id).selectedIndex = 0);
        drawAll();
      });
      ['f_country','f_partnerCat','f_agreement','f_industry','f_cpm','f_product','f_lead','f_mkt','f_age','groupBy']
        .forEach(id=> document.getElementById(id).addEventListener('change', drawAll));

      drawAll();
    }
  })();
  </script>
</body>
</html>
